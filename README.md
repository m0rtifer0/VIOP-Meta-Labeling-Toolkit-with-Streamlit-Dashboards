# VIOP Meta-Labeling and Stochastic Simulation Toolkit

A comprehensive Python toolkit for algorithmic trading on BIST VIOP (Turkish Futures Market) featuring:

- **Meta-Labeling Pipeline**: Machine learning approach to filter false positives from technical trading signals
- **BIST100 Real Data Pipeline**: Meta-labeling with real market data from Yahoo Finance
- **Stochastic Simulation Dashboard**: Interactive Streamlit application for Monte Carlo simulations

## Table of Contents

- [Overview](#overview)
- [Features](#features)
- [Installation](#installation)
- [Usage](#usage)
- [Project Structure](#project-structure)
- [Methodology](#methodology)
- [License](#license)

## Overview

This project implements three main components for quantitative trading research:

### 1. Meta-Labeling Pipeline (Synthetic Data)

The meta-labeling approach, popularized by Marcos Lopez de Prado, uses a secondary ML model to predict the probability of success for signals generated by a primary (base) strategy. This allows traders to:

- Filter out low-confidence trades
- Size positions based on prediction confidence
- Improve risk-adjusted returns by reducing false positives

### 2. BIST100 Real Data Pipeline

Extended version that fetches 10 years of BIST100 index data from Yahoo Finance (or loads from CSV) and applies the complete Meta-Labeling framework with enhanced features including:

- MACD, Bollinger Bands, multiple EMAs
- Automatic fallback to synthetic data if Yahoo Finance is rate-limited
- Comprehensive visualization of results

### 3. Stochastic Simulation Dashboard

An interactive web application for running Monte Carlo simulations including:

- Geometric Brownian Motion (GBM) price path simulation
- Monte Carlo option pricing with Greeks estimation
- Strategy backtesting with confidence intervals
- Value at Risk (VaR) and Conditional VaR analysis

## Features

### Meta-Labeling Pipeline

| Feature | Description |
|---------|-------------|
| Volatility-Normalized Features | Returns/ATR, Distance-from-MA/ATR for regime-independent signals |
| Triple Barrier Labeling | Dynamic TP/SL based on ATR with time-based vertical barrier |
| XGBoost Classifier | Gradient boosting with class imbalance handling |
| Walk-Forward Validation | Time series cross-validation to prevent look-ahead bias |
| Strategy Comparison | Equity curves for naive vs ML-filtered approaches |

### Stochastic Simulator Dashboard

| Module | Description |
|--------|-------------|
| GBM Simulation | Simulate future price paths with drift and volatility parameters |
| Option Pricing | Monte Carlo pricing for European options with Black-Scholes comparison |
| Strategy Backtest | Simulate strategy performance with win rate and risk parameters |
| VaR Analysis | Calculate portfolio Value at Risk and Expected Shortfall |

## Installation

### Prerequisites

- Python 3.8 or higher
- pip package manager

### Setup

1. Clone the repository:

```bash
git clone https://github.com/yourusername/viop-meta-labeling.git
cd viop-meta-labeling
```

2. Create a virtual environment (recommended):

```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. Install dependencies:

```bash
pip install -r requirements.txt
```

## Usage

### Running the Meta-Labeling Pipeline (Synthetic Data)

```bash
python meta_labeling_pipeline.py
```

### Running the BIST100 Real Data Pipeline

```bash
python bist100_meta_labeling.py
```

This will:
1. Fetch 10 years of BIST100 data from Yahoo Finance (or generate synthetic data if rate-limited)
2. Compute 25+ volatility-normalized features
3. Generate base strategy signals (RSI + MACD based)
4. Apply Triple Barrier labeling
5. Train XGBoost meta-model with walk-forward validation
6. Output comparison metrics and save visualization

To use your own CSV data:
```python
# In bist100_meta_labeling.py, modify the main() function:
df = fetch_bist100_data(csv_path='your_data.csv')
```

### Running the Stochastic Simulator Dashboard

```bash
streamlit run stochastic_simulator.py
```

### Running the BIST100 Meta-Labeling Dashboard

```bash
streamlit run bist100_dashboard.py
```

This interactive dashboard provides:
- Real-time parameter tuning for signals and barriers
- Walk-forward validation results
- Monte Carlo simulations for strategy performance
- VaR/CVaR risk metrics
- Feature importance analysis

Navigate to `http://localhost:8501` in your browser to access the interactive dashboards.

## Project Structure

```
viop-meta-labeling/
├── meta_labeling_pipeline.py      # Meta-labeling with synthetic data
├── bist100_meta_labeling.py       # Meta-labeling with real BIST100 data
├── bist100_dashboard.py           # Interactive BIST100 Meta-Labeling dashboard
├── stochastic_simulator.py        # Streamlit dashboard for general simulations
├── requirements.txt               # Python dependencies
├── .gitignore                     # Git ignore file
├── LICENSE                        # MIT License
└── README.md                      # This file
```

## Methodology

### Volatility Normalization

Raw price-based features are non-stationary - their distributions shift with market regimes. By normalizing with ATR (Average True Range), we create stationary features that:

1. Have consistent distributions across time
2. Enable the ML model to learn patterns that generalize
3. Reduce the need for constant model retraining

Example: "Price dropped 50 points" means nothing alone. "Price dropped 2 ATRs" is universally significant.

### Triple Barrier Method

Traditional fixed-time labeling ignores realistic trading mechanics. The Triple Barrier approach models actual trades:

1. **Upper Barrier (Take Profit)**: Exit if profit target is hit (e.g., 2x ATR)
2. **Lower Barrier (Stop Loss)**: Exit if loss limit is hit (e.g., 1x ATR)
3. **Vertical Barrier (Time Stop)**: Exit if neither barrier is hit within max holding period

ATR-based barriers adapt to current market volatility, ensuring consistent risk across different regimes.

### Walk-Forward Validation

Standard K-Fold cross-validation shuffles data, causing look-ahead bias. Walk-Forward validation:

- Trains on past data, validates on future data (never the reverse)
- Each fold moves forward in time
- Mimics actual trading where future data is unavailable

## Configuration

### Meta-Labeling Parameters

Key parameters in `meta_labeling_pipeline.py`:

```python
# Triple Barrier settings
pt_mult = 2.0      # Take profit multiplier (ATR units)
sl_mult = 1.0      # Stop loss multiplier (ATR units)
max_holding = 10   # Maximum bars to hold position

# XGBoost parameters
max_depth = 4
learning_rate = 0.05
n_estimators = 200

# Validation
n_splits = 5       # Number of walk-forward folds
threshold = 0.6    # Probability threshold for signal filtering
```

### Dashboard Parameters

All parameters are adjustable via the Streamlit sidebar interface.

## Output

### Meta-Labeling Pipeline

- Console output with fold-by-fold metrics
- `meta_labeling_results.png`: Equity curves and feature importance visualization
- Precision, Recall, and AUC-ROC metrics

### Stochastic Simulator

- Interactive Plotly visualizations
- Real-time metric calculations
- Downloadable simulation results

## Dependencies

- numpy
- pandas
- xgboost
- scikit-learn
- streamlit
- plotly
- scipy

See `requirements.txt` for complete list with versions.

## Contributing

Contributions are welcome. Please follow these steps:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/new-feature`)
3. Commit your changes (`git commit -am 'Add new feature'`)
4. Push to the branch (`git push origin feature/new-feature`)
5. Open a Pull Request

## References

- Lopez de Prado, M. (2018). Advances in Financial Machine Learning. Wiley.
- Triple Barrier Method: Chapter 3 of AFML
- Meta-Labeling: Chapter 3.6 of AFML

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Disclaimer

This software is for educational and research purposes only. It is not financial advice. Trading futures and derivatives involves substantial risk of loss. Past performance is not indicative of future results.
